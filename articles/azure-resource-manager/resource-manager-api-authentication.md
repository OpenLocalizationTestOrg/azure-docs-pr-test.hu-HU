---
title: "Az Azure Active Directory-hitelesítés és erőforrás-kezelő |} Microsoft Docs"
description: "A fejlesztői útmutató az alkalmazások integrálása más Azure-előfizetések az Azure Resource Manager API és az Azure Active Directory-hitelesítés."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="58a27-103">Erőforrás-kezelő használata hitelesítési API access előfizetésekhez</span><span class="sxs-lookup"><span data-stu-id="58a27-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="58a27-104">Bevezetés</span><span class="sxs-lookup"><span data-stu-id="58a27-104">Introduction</span></span>
<span data-ttu-id="58a27-105">Ha egy szoftver fejlesztőről, aki létre kell hoznia egy alkalmazást, amely felügyeli az ügyfél Azure-erőforrások, a jelen témakör bemutatja, hogyan hitelesítik magukat az Azure Resource Manager API-k és más előfizetések lévő erőforrások eléréséhez.</span><span class="sxs-lookup"><span data-stu-id="58a27-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="58a27-106">Az alkalmazás férhetnek hozzá a Resource Manager API-k több módon:</span><span class="sxs-lookup"><span data-stu-id="58a27-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="58a27-107">**Felhasználói + alkalmazás-hozzáférés**: az alkalmazáshoz, amelyet a bejelentkezett felhasználó nevében erőforrásokhoz férnek hozzá.</span><span class="sxs-lookup"><span data-stu-id="58a27-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="58a27-108">Ez a módszer az alkalmazások, például webes alkalmazásokat vagy csak "interaktív kezelése" Azure-erőforrások kezelésére szolgáló parancssori eszköz működik.</span><span class="sxs-lookup"><span data-stu-id="58a27-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="58a27-109">**Csak alkalmazás hozzáférés**: démon szolgáltatások és az ütemezett feladatok futó alkalmazások számára.</span><span class="sxs-lookup"><span data-stu-id="58a27-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="58a27-110">Az alkalmazás identitását közvetlen hozzáférést az erőforrásokhoz.</span><span class="sxs-lookup"><span data-stu-id="58a27-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="58a27-111">Ez a megközelítés hosszú távú távfelügyeleti (felügyelet) Azure-hozzáférést igénylő alkalmazások esetében működik.</span><span class="sxs-lookup"><span data-stu-id="58a27-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="58a27-112">Ez a témakör részletes útmutatást nyújt egy alkalmazás ezek hitelesítési módszerek által létrehozásához.</span><span class="sxs-lookup"><span data-stu-id="58a27-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="58a27-113">Azt illusztrálja, hogyan REST API-t vagy a C# egyes lépéseinek végrehajtásához.</span><span class="sxs-lookup"><span data-stu-id="58a27-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="58a27-114">A teljes ASP.NET MVC alkalmazás érhető el: [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="58a27-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="58a27-115">A webalkalmazás funkciója</span><span class="sxs-lookup"><span data-stu-id="58a27-115">What the web app does</span></span>
<span data-ttu-id="58a27-116">A webalkalmazás:</span><span class="sxs-lookup"><span data-stu-id="58a27-116">The web app:</span></span>

1. <span data-ttu-id="58a27-117">Bejelentkezik egy Azure felhasználói.</span><span class="sxs-lookup"><span data-stu-id="58a27-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="58a27-118">Megkérdezi a felhasználót, hogy a hozzáférést a webes alkalmazás erőforrás-kezelő.</span><span class="sxs-lookup"><span data-stu-id="58a27-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="58a27-119">Lekérdezi a felhasználó + alkalmazás hozzáférési jogkivonat erőforrás-kezelő eléréséhez.</span><span class="sxs-lookup"><span data-stu-id="58a27-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="58a27-120">Használja a jogkivonatot (a 3. lépés) erőforrás-kezelő és az app service principal hozzárendelése egy szerepkörhöz az előfizetést, amelyet az alkalmazásnak a hosszú távú hozzáférést ad az előfizetés.</span><span class="sxs-lookup"><span data-stu-id="58a27-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="58a27-121">Csak alkalmazás-hozzáférési jogkivonat lekérése.</span><span class="sxs-lookup"><span data-stu-id="58a27-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="58a27-122">(Az 5. lépés) token használatával kezelheti az erőforrásokat az előfizetés Resource Manageren keresztül.</span><span class="sxs-lookup"><span data-stu-id="58a27-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="58a27-123">Ez a webalkalmazás-végpontok közötti áramlását.</span><span class="sxs-lookup"><span data-stu-id="58a27-123">Here's the end-to-end flow of the web application.</span></span>

![Erőforrás-kezelő hitelesítési folyamat](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="58a27-125">Egy felhasználó nevében a használni kívánt előfizetést adja meg az előfizetés-azonosító:</span><span class="sxs-lookup"><span data-stu-id="58a27-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![Adja meg az előfizetés-azonosító](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="58a27-127">Válassza ki a bejelentkezéshez használt fiókot.</span><span class="sxs-lookup"><span data-stu-id="58a27-127">Select the account to use for logging in.</span></span>

![Válasszon fiókot](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="58a27-129">Adja meg a hitelesítő adatokat.</span><span class="sxs-lookup"><span data-stu-id="58a27-129">Provide your credentials.</span></span>

![Adjon meg hitelesítő adatokat](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="58a27-131">Hozzáférést biztosítania az alkalmazásnak az Azure-előfizetések:</span><span class="sxs-lookup"><span data-stu-id="58a27-131">Grant the app access to your Azure subscriptions:</span></span>

![Hozzáférés biztosítása](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="58a27-133">A csatlakoztatott előfizetések kezelése:</span><span class="sxs-lookup"><span data-stu-id="58a27-133">Manage your connected subscriptions:</span></span>

![Csatlakozás az előfizetés](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="58a27-135">Alkalmazás regisztrálása</span><span class="sxs-lookup"><span data-stu-id="58a27-135">Register application</span></span>
<span data-ttu-id="58a27-136">A kezdéshez kódolási regisztrálja a webalkalmazás az Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="58a27-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="58a27-137">Az alkalmazás regisztrálása egy központi identitás, az alkalmazás az Azure AD-hoz létre.</span><span class="sxs-lookup"><span data-stu-id="58a27-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="58a27-138">Magánál tartja alapvető információkat az alkalmazásról, mint OAuth-Ügyfélazonosító, a válasz URL-címek és a hitelesítő adatokkal, amelyek az alkalmazás hitelesítéséhez, és az Azure Resource Manager API-k eléréséhez.</span><span class="sxs-lookup"><span data-stu-id="58a27-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="58a27-139">Az alkalmazás regisztrálása a különböző delegált jogosultságokkal sikeresen telepítették az alkalmazást igénylő Microsoft APIs elérésekor, a felhasználó nevében is rögzíti.</span><span class="sxs-lookup"><span data-stu-id="58a27-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="58a27-140">Az alkalmazás más előfizetés fér hozzá, mert a több-bérlős alkalmazásként kell konfigurálnia.</span><span class="sxs-lookup"><span data-stu-id="58a27-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="58a27-141">Érvényesítési átadni, adja meg egy társított az Azure Active Directory tartományi.</span><span class="sxs-lookup"><span data-stu-id="58a27-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="58a27-142">Az Azure Active Directory társított tartományokat megtekintéséhez jelentkezzen be a [klasszikus portál](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="58a27-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="58a27-143">Válassza ki az Azure Active Directory majd **tartományok**.</span><span class="sxs-lookup"><span data-stu-id="58a27-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="58a27-144">A következő példa bemutatja, hogyan kell regisztrálni az alkalmazás az Azure PowerShell használatával.</span><span class="sxs-lookup"><span data-stu-id="58a27-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="58a27-145">A parancs működéséhez az Azure PowerShell legfrissebb (2016 augusztusától) kell rendelkeznie.</span><span class="sxs-lookup"><span data-stu-id="58a27-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="58a27-146">Jelentkezzen be az AD-alkalmazás, az alkalmazás azonosítóját és jelszavát kell.</span><span class="sxs-lookup"><span data-stu-id="58a27-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="58a27-147">Az alkalmazásazonosító, amely küld vissza az előző parancsot használja:</span><span class="sxs-lookup"><span data-stu-id="58a27-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="58a27-148">A következő példa bemutatja, hogyan kell regisztrálni az alkalmazás az Azure parancssori felület használatával.</span><span class="sxs-lookup"><span data-stu-id="58a27-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="58a27-149">Az eredmények tartalmazzák az alkalmazásazonosító, amely megegyezik az alkalmazáséval hitelesítéséhez szükséges.</span><span class="sxs-lookup"><span data-stu-id="58a27-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="58a27-150">Opcionális konfigurációs - tanúsítvány hitelesítő adatok</span><span class="sxs-lookup"><span data-stu-id="58a27-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="58a27-151">Az alkalmazások is támogatja tanúsítvány hitelesítő adatokat az Azure AD: hozzon létre egy önaláírt tanúsítványt, tartsa a titkos kulcsot, majd adja hozzá a nyilvános kulcsot az Azure AD-alkalmazás regisztrációja.</span><span class="sxs-lookup"><span data-stu-id="58a27-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="58a27-152">A hitelesítéshez az alkalmazás egy kis hasznos küld az Azure AD a titkos kulccsal aláírva, és az Azure AD ellenőrzi az aláírást a nyilvános kulccsal regisztrált.</span><span class="sxs-lookup"><span data-stu-id="58a27-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="58a27-153">Az AD-alkalmazás létrehozása a tanúsítvánnyal kapcsolatos információkért lásd: [a Azure PowerShell szolgáltatás használatával hozzon létre egy egyszerű erőforrások eléréséhez](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) vagy [használja az Azure parancssori felület erőforrásokhoz való hozzáféréshez egyszerű szolgáltatás létrehozása](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate) .</span><span class="sxs-lookup"><span data-stu-id="58a27-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="58a27-154">Előfizetés-azonosító bérlőazonosító beszerzése</span><span class="sxs-lookup"><span data-stu-id="58a27-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="58a27-155">Kérjen meg egy jogkivonatot, amely hívja az erőforrás-kezelő használható, az alkalmazás tudnia kell, a bérlő azonosítója, amelyen az Azure-előfizetéshez az Azure AD-bérlő.</span><span class="sxs-lookup"><span data-stu-id="58a27-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="58a27-156">Nagy valószínűséggel a felhasználókkal, hogy az előfizetés-azonosítók, de előfordulhat, hogy nem tudják a bérlői azonosító az Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="58a27-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="58a27-157">Ahhoz, hogy a felhasználó bérlőazonosító, kérje meg a felhasználó az előfizetés-azonosító.</span><span class="sxs-lookup"><span data-stu-id="58a27-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="58a27-158">Az előfizetéssel kapcsolatos igényel, adja meg, hogy az előfizetés-azonosító:</span><span class="sxs-lookup"><span data-stu-id="58a27-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="58a27-159">A kérés nem teljesíthető, mert a felhasználó nem bejelentkezése még, de a válasz kérhetnek le a bérlő azonosítója.</span><span class="sxs-lookup"><span data-stu-id="58a27-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="58a27-160">Ezt a kivételt a beolvasni a bérlő azonosítóját a válasz fejléc értéke **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="58a27-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="58a27-161">Ebben az implementációban a látja a [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) metódust.</span><span class="sxs-lookup"><span data-stu-id="58a27-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="58a27-162">Felhasználói + alkalmazás hozzáférési jogkivonat beszerzése</span><span class="sxs-lookup"><span data-stu-id="58a27-162">Get user + app access token</span></span>
<span data-ttu-id="58a27-163">Az alkalmazás átirányítja a felhasználót az Azure AD és az OAuth 2.0 engedélyezik kérelem - hitelesítéshez a felhasználó hitelesítő adatait, és vissza egy engedélyezési kódot.</span><span class="sxs-lookup"><span data-stu-id="58a27-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="58a27-164">Az alkalmazás az engedélyezési kód használatával szerezze be a hozzáférési tokent az erőforrás-kezelő.</span><span class="sxs-lookup"><span data-stu-id="58a27-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="58a27-165">A [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) hoz létre a hitelesítési kérelmet.</span><span class="sxs-lookup"><span data-stu-id="58a27-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="58a27-166">Ez a témakör bemutatja a REST API-kérés hitelesíteni a felhasználót.</span><span class="sxs-lookup"><span data-stu-id="58a27-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="58a27-167">Segítő tárak segítségével is végezhet hitelesítést a kódban.</span><span class="sxs-lookup"><span data-stu-id="58a27-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="58a27-168">Ezek a kódtárak kapcsolatos további információkért lásd: [Azure Active Directory hitelesítési Kódtárai](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="58a27-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="58a27-169">Egy alkalmazás Identitáskezelés integrálásával útmutatóért lásd: [Azure Active Directory fejlesztői útmutatója](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="58a27-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="58a27-170">Hitelesítési kérelmek (OAuth 2.0-s)</span><span class="sxs-lookup"><span data-stu-id="58a27-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="58a27-171">Egy nyitott azonosító Connect/OAuth2.0 engedélyezik lekérdezési ki az Azure AD-hitelesítési végpontra:</span><span class="sxs-lookup"><span data-stu-id="58a27-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="58a27-172">A lekérdezési karakterlánc elérhető paramétereket a kérelemhez tartozó ismerteti a [egy engedélyezési kód kérése](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) témakör.</span><span class="sxs-lookup"><span data-stu-id="58a27-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="58a27-173">A következő példa bemutatja, hogyan OAuth2.0 engedély kérése:</span><span class="sxs-lookup"><span data-stu-id="58a27-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="58a27-174">Az Azure AD akkor hitelesíti a felhasználót, és, ha szükséges, megkérdezi a felhasználót, hogy az alkalmazás engedélyt.</span><span class="sxs-lookup"><span data-stu-id="58a27-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="58a27-175">Az engedélyezési kódot adja vissza, az alkalmazás válasz URL-címét.</span><span class="sxs-lookup"><span data-stu-id="58a27-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="58a27-176">Attól függően, a kért response_mode, az Azure AD vagy küld vissza az adatok a lekérdezési karakterláncban vagy post-adatokat.</span><span class="sxs-lookup"><span data-stu-id="58a27-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="58a27-177">Hitelesítési kérelmek (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="58a27-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="58a27-178">Ha nem csak szeretné elérni az Azure Resource Manager a felhasználó nevében, de is lehetővé teszi a felhasználó bejelentkezni az alkalmazás használatával az Azure AD-fiókot, ki egy nyitott azonosító csatlakozás engedélyezése lekérdezési.</span><span class="sxs-lookup"><span data-stu-id="58a27-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="58a27-179">A Open ID Connect az alkalmazás is kap egy id_token, amelyek az alkalmazás a felhasználói bejelentkezés az Azure AD-ből.</span><span class="sxs-lookup"><span data-stu-id="58a27-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="58a27-180">A lekérdezési karakterlánc elérhető paramétereket a kérelemhez tartozó ismerteti a [a bejelentkezési kérelem küldése](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) témakör.</span><span class="sxs-lookup"><span data-stu-id="58a27-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="58a27-181">A következő egy példa egy Open ID Connect kérelem:</span><span class="sxs-lookup"><span data-stu-id="58a27-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="58a27-182">Az Azure AD akkor hitelesíti a felhasználót, és, ha szükséges, megkérdezi a felhasználót, hogy az alkalmazás engedélyt.</span><span class="sxs-lookup"><span data-stu-id="58a27-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="58a27-183">Az engedélyezési kódot adja vissza, az alkalmazás válasz URL-címét.</span><span class="sxs-lookup"><span data-stu-id="58a27-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="58a27-184">Attól függően, a kért response_mode, az Azure AD vagy küld vissza az adatok a lekérdezési karakterláncban vagy post-adatokat.</span><span class="sxs-lookup"><span data-stu-id="58a27-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="58a27-185">Az Open ID Connect válasz példája:</span><span class="sxs-lookup"><span data-stu-id="58a27-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="58a27-186">Jogkivonatkérelem (OAuth2.0 Code Grant Flow)</span><span class="sxs-lookup"><span data-stu-id="58a27-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="58a27-187">Most, hogy az alkalmazás az Azure AD-ből kapott engedélyezési kódot, akkor szerezze be a hozzáférési tokent az Azure Resource Manager időt.</span><span class="sxs-lookup"><span data-stu-id="58a27-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="58a27-188">Írjon egy OAuth2.0 Code Grant Token elküldeni a kérelmet az Azure AD Token-végpont:</span><span class="sxs-lookup"><span data-stu-id="58a27-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="58a27-189">A lekérdezési karakterlánc elérhető paramétereket a kérelemhez tartozó ismerteti a [használata az engedélyezési kód](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) témakör.</span><span class="sxs-lookup"><span data-stu-id="58a27-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="58a27-190">A következő példa bemutatja egy kérelem a code grant token jelszó hitelesítő adat:</span><span class="sxs-lookup"><span data-stu-id="58a27-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="58a27-191">Az használatakor tanúsítvány hitelesítő adatait, hozzon létre egy JSON webes jogkivonat (JWT) és a bejelentkezési (RSA SHA256), a titkos kulcsot a az alkalmazás tanúsítvány hitelesítő adatok használatával.</span><span class="sxs-lookup"><span data-stu-id="58a27-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="58a27-192">A jogkivonat esetében a jogcím-típusok megjelennek-e [JWT jogkivonat jogcímek](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="58a27-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="58a27-193">Referenciáért lásd: a [Active Directory hitelesítési könyvtár (.NET) kód](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) ügyfél helyességi feltétel JWT-jogkivonatokat aláírásához.</span><span class="sxs-lookup"><span data-stu-id="58a27-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="58a27-194">Tekintse meg a [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) talál részletes információt ügyfél-hitelesítéshez.</span><span class="sxs-lookup"><span data-stu-id="58a27-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="58a27-195">A következő példa bemutatja egy kérelem a code grant token tanúsítvány hitelesítő adat:</span><span class="sxs-lookup"><span data-stu-id="58a27-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="58a27-196">Egy példa egy válasz code grant jogkivonat:</span><span class="sxs-lookup"><span data-stu-id="58a27-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="58a27-197">Kezeli a code grant token válasz</span><span class="sxs-lookup"><span data-stu-id="58a27-197">Handle code grant token response</span></span>
<span data-ttu-id="58a27-198">A sikeres token válasz tartalmazza a (felhasználó + alkalmazás) hozzáférési jogkivonatot az Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="58a27-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="58a27-199">Az alkalmazás erőforrás-kezelő eléréséhez a felhasználó nevében a hozzáférési jogkivonatot használja.</span><span class="sxs-lookup"><span data-stu-id="58a27-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="58a27-200">Az Azure AD által kibocsátott hozzáférési jogkivonatok élettartama 1 óra.</span><span class="sxs-lookup"><span data-stu-id="58a27-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="58a27-201">Nem valószínű, hogy a webes alkalmazás kell megújítani a (felhasználó + alkalmazás) hozzáférési jogkivonat.</span><span class="sxs-lookup"><span data-stu-id="58a27-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="58a27-202">Ha a hozzáférési jogkivonat megújításához szükséges, használja a frissítési jogkivonatot, amely a token válasz kap az alkalmazáshoz.</span><span class="sxs-lookup"><span data-stu-id="58a27-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="58a27-203">Írjon egy OAuth2.0 Token elküldeni a kérelmet az Azure AD Token-végpont:</span><span class="sxs-lookup"><span data-stu-id="58a27-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="58a27-204">A frissítési kérelem használandó paraméterek ismertetett [a hozzáférési jogkivonat frissítését](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="58a27-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="58a27-205">A következő példa bemutatja, hogyan használja a frissítési token:</span><span class="sxs-lookup"><span data-stu-id="58a27-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="58a27-206">Bár a frissítési jogkivonatokat új hozzáférési jogkivonatok lekérésére, ha az Azure Resource Manager használatával lehet, nem alkalmasak legyenek offline hozzáférés az alkalmazás.</span><span class="sxs-lookup"><span data-stu-id="58a27-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="58a27-207">A frissítési jogkivonatok élettartama korlátozott, és a felhasználó köti a frissítési jogkivonatokat.</span><span class="sxs-lookup"><span data-stu-id="58a27-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="58a27-208">Ha a felhasználó elhagyja a szervezetet, az alkalmazás a frissítési jogkivonat használatával elveszítette a hozzáférését.</span><span class="sxs-lookup"><span data-stu-id="58a27-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="58a27-209">Ez a módszer nem megfelelő-e az Azure erőforrások kezeléséhez csapatok által használt alkalmazások.</span><span class="sxs-lookup"><span data-stu-id="58a27-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="58a27-210">Ha a felhasználó hozzáférési jogosultságot rendelhet előfizetés ellenőrzése</span><span class="sxs-lookup"><span data-stu-id="58a27-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="58a27-211">Az alkalmazás most már rendelkezik egy token Azure Resource Manager hozzáférni a felhasználó nevében.</span><span class="sxs-lookup"><span data-stu-id="58a27-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="58a27-212">A következő lépés, hogy az alkalmazás csatlakoztatása az előfizetést.</span><span class="sxs-lookup"><span data-stu-id="58a27-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="58a27-213">A csatlakozás után az alkalmazás kezelhető előfizetésekben akkor is, ha a felhasználó nem található (hosszú távú offline hozzáférést).</span><span class="sxs-lookup"><span data-stu-id="58a27-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="58a27-214">Az egyes előfizetésekhez való csatlakozáshoz, hívja az [erőforrás-kezelő listázási engedély](https://docs.microsoft.com/rest/api/authorization/permissions) API annak meghatározásához, hogy a felhasználó rendelkezik-e felügyeleti jogokkal az előfizetéshez.</span><span class="sxs-lookup"><span data-stu-id="58a27-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="58a27-215">A [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) az ASP.NET MVC mintaalkalmazás metódus valósítja meg a hívás.</span><span class="sxs-lookup"><span data-stu-id="58a27-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="58a27-216">A következő példa bemutatja, hogyan előfizetésekből a felhasználói engedélyek kéréséhez.</span><span class="sxs-lookup"><span data-stu-id="58a27-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="58a27-217">83cfe939-2402-4581-b761-4f59b0a041e4 az előfizetés azonosítóját.</span><span class="sxs-lookup"><span data-stu-id="58a27-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="58a27-218">A válasz felhasználói jogosultságok megszerzéséhez előfizetésben példa, hogy:</span><span class="sxs-lookup"><span data-stu-id="58a27-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="58a27-219">Az engedélyek API több engedélyeket ad vissza.</span><span class="sxs-lookup"><span data-stu-id="58a27-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="58a27-220">Minden engedélyt engedélyezett műveletek (műveletek) áll, és nem engedélyezett műveletek (notactions).</span><span class="sxs-lookup"><span data-stu-id="58a27-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="58a27-221">Ha a művelet bármilyen engedéllyel engedélyezett műveletek listája szerepel, és nem szerepel az engedélyt notactions listája, a felhasználó számára engedélyezett az adott művelet végrehajtására.</span><span class="sxs-lookup"><span data-stu-id="58a27-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="58a27-222">**Microsoft.Authorization/RoleAssignments/Write** hozzáférés jogosultságait, amely engedélyezi a műveletet.</span><span class="sxs-lookup"><span data-stu-id="58a27-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="58a27-223">Az alkalmazás a engedélyek eredmény, keresse meg a művelet karakterlánc műveletek és minden engedély notactions reguláris kifejezéssel egyező kell elemezni.</span><span class="sxs-lookup"><span data-stu-id="58a27-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="58a27-224">Csak alkalmazás-token beszerzése</span><span class="sxs-lookup"><span data-stu-id="58a27-224">Get app-only access token</span></span>
<span data-ttu-id="58a27-225">Most már tudja, ha a felhasználó hozzáférési jogosultságot rendelhet az Azure-előfizetés.</span><span class="sxs-lookup"><span data-stu-id="58a27-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="58a27-226">A következő lépések a következők:</span><span class="sxs-lookup"><span data-stu-id="58a27-226">The next steps are:</span></span>

1. <span data-ttu-id="58a27-227">A megfelelő RBAC szerepkör hozzárendelése az alkalmazásidentitás az előfizetésben.</span><span class="sxs-lookup"><span data-stu-id="58a27-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="58a27-228">Ellenőrizze a hozzáférés hozzárendelése az alkalmazás engedélyt az előfizetésben lekérdezésével vagy erőforrás-kezelő csak alkalmazás tokent elérésével.</span><span class="sxs-lookup"><span data-stu-id="58a27-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="58a27-229">Jegyezze fel a kapcsolatot az alkalmazások "csatlakoztatott előfizetések" adatszerkezet - megőrzése az előfizetés azonosítóját a.</span><span class="sxs-lookup"><span data-stu-id="58a27-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="58a27-230">Nézzük szorosabb az első lépésben.</span><span class="sxs-lookup"><span data-stu-id="58a27-230">Let's look closer at the first step.</span></span> <span data-ttu-id="58a27-231">A megfelelő RBAC szerepkör hozzárendelése az alkalmazás azonosítóját, meg kell határoznia:</span><span class="sxs-lookup"><span data-stu-id="58a27-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="58a27-232">Az alkalmazás azonosítóját a felhasználó Azure Active Directoryban objektum azonosítója</span><span class="sxs-lookup"><span data-stu-id="58a27-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="58a27-233">Az RBAC szerepkör, az alkalmazás által az előfizetés azonosítóját</span><span class="sxs-lookup"><span data-stu-id="58a27-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="58a27-234">Az alkalmazás hitelesíti a felhasználót az Azure AD-ből, ha azt hoz létre egyszerű az alkalmazáshoz, hogy az Azure AD-ben.</span><span class="sxs-lookup"><span data-stu-id="58a27-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="58a27-235">Azure lehetővé teszi, hogy az RBAC-szerepkörök közvetlen hozzáférést biztosít az Azure-erőforrások a megfelelő alkalmazások szolgáltatásnevekről hozzárendelését.</span><span class="sxs-lookup"><span data-stu-id="58a27-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="58a27-236">Erre akkor pontosan mit jelenítsük elvégzéséhez.</span><span class="sxs-lookup"><span data-stu-id="58a27-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="58a27-237">Lekérdezés az Azure AD Graph API meghatározni a szolgáltatás egyszerű annak az alkalmazásnak a bejelentkezett felhasználó azonosítóját az Azure AD meg.</span><span class="sxs-lookup"><span data-stu-id="58a27-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="58a27-238">Csak akkor kell egy hozzáférési jogkivonatot az Azure Resource Manager - az Azure AD Graph API hívása új tokenre van szüksége.</span><span class="sxs-lookup"><span data-stu-id="58a27-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="58a27-239">Az Azure ad-ben minden alkalmazásnak a saját szolgáltatás egyszerű objektum lekérdezése, így csak alkalmazás-hozzáférési tokent elegendő jogosultsága.</span><span class="sxs-lookup"><span data-stu-id="58a27-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="58a27-240">Szerezze be a csak alkalmazás-hozzáférési tokent az Azure AD Graph API</span><span class="sxs-lookup"><span data-stu-id="58a27-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="58a27-241">Hitelesítsék az alkalmazást, és egy tokent a Azure AD Graph API, adjon ki egy ügyfél-hitelesítő adat Grant OAuth2.0 folyamat token kérelmet az Azure AD-jogkivonat végpontjához (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="58a27-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="58a27-242">A [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) metódus az ASP.net MVC mintaalkalmazásnak lekéri csak alkalmazás hozzáférés token Graph API segítségével az Active Directory Authentication Library .NET-keretrendszerhez készült.</span><span class="sxs-lookup"><span data-stu-id="58a27-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="58a27-243">A lekérdezési karakterlánc elérhető paramétereket a kérelemhez tartozó ismerteti a [kérelem egy hozzáférési jogkivonat](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) témakör.</span><span class="sxs-lookup"><span data-stu-id="58a27-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="58a27-244">Egy példa egy kérelem ügyfél-hitelesítési jogkivonat engedélyezése:</span><span class="sxs-lookup"><span data-stu-id="58a27-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="58a27-245">Egy példa egy válasz ügyfél-hitelesítési jogkivonat engedélyezése:</span><span class="sxs-lookup"><span data-stu-id="58a27-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="58a27-246">A felhasználó az Azure AD az alkalmazás egyszerű ObjectId beolvasása</span><span class="sxs-lookup"><span data-stu-id="58a27-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="58a27-247">A lekérdezés csak alkalmazás hozzáférési jogkivonatát, használja a [Azure AD Graph Szolgáltatásnevekről](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API használatával határozza meg a könyvtárban az alkalmazás egyszerű objektumazonosítója.</span><span class="sxs-lookup"><span data-stu-id="58a27-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="58a27-248">A [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) az ASP.net MVC mintaalkalmazásnak metódus valósítja meg a hívás.</span><span class="sxs-lookup"><span data-stu-id="58a27-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="58a27-249">A következő példa bemutatja, hogyan kérjen egy alkalmazás egyszerű.</span><span class="sxs-lookup"><span data-stu-id="58a27-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="58a27-250">a0448380-c346-4f9f-b897-c18733de9394 az alkalmazás ügyfél-azonosító.</span><span class="sxs-lookup"><span data-stu-id="58a27-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="58a27-251">A következő példa bemutatja egy olyan alkalmazás szolgáltatás kérelemre adott válasz egyszerű</span><span class="sxs-lookup"><span data-stu-id="58a27-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="58a27-252">Azure RBAC szerepkör-azonosító lekérése</span><span class="sxs-lookup"><span data-stu-id="58a27-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="58a27-253">A megfelelő RBAC szerepkört rendelni az egyszerű szolgáltatásnév, meg kell határoznia, az Azure RBAC-szerepkör azonosítóját.</span><span class="sxs-lookup"><span data-stu-id="58a27-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="58a27-254">A megfelelő RBAC szerepkört az alkalmazáshoz:</span><span class="sxs-lookup"><span data-stu-id="58a27-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="58a27-255">Ha az alkalmazás csak figyeli az előfizetést, változtatások nélkül, az előfizetés csak olvasási engedélyre van szükség.</span><span class="sxs-lookup"><span data-stu-id="58a27-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="58a27-256">Rendelje hozzá a **olvasó** szerepkör.</span><span class="sxs-lookup"><span data-stu-id="58a27-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="58a27-257">Ha az alkalmazás kezeli az Azure az előfizetés létrehozása/módosítása vagy törlése entitások egyikét igényli a közreműködői engedélyekkel.</span><span class="sxs-lookup"><span data-stu-id="58a27-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="58a27-258">Kezelheti egy adott típusú erőforrás, rendelje hozzá az erőforrás-specifikus közreműködői szerepkör (virtuális gép közreműködő, virtuális hálózat közreműködő, tárolási fiók közreműködői, stb.)</span><span class="sxs-lookup"><span data-stu-id="58a27-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="58a27-259">Az összes erőforrástípus kezeléséhez rendelje hozzá a **közreműködő** szerepkör.</span><span class="sxs-lookup"><span data-stu-id="58a27-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="58a27-260">A szerepkör-hozzárendelést az alkalmazás akkor látható, a felhasználók számára, így jelölje be a legkevesebb szükséges jogosultsággal.</span><span class="sxs-lookup"><span data-stu-id="58a27-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="58a27-261">Hívja a [erőforrás-kezelő szerepkör-definíció API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) kilistázhatja az összes Azure RBAC-szerepkörök és keresési, akkor az eredmény a kívánt szerepkör-definíció név szerinti keresése ismétlés.</span><span class="sxs-lookup"><span data-stu-id="58a27-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="58a27-262">A [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) az ASP.net MVC mintaalkalmazás metódus valósítja meg a hívás.</span><span class="sxs-lookup"><span data-stu-id="58a27-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="58a27-263">A következő kérés példa bemutatja, hogyan kérhet az Azure RBAC szerepkör-azonosító.</span><span class="sxs-lookup"><span data-stu-id="58a27-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="58a27-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb az előfizetés azonosítóját.</span><span class="sxs-lookup"><span data-stu-id="58a27-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="58a27-265">A válasz a következő formátumban kell megadni:</span><span class="sxs-lookup"><span data-stu-id="58a27-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="58a27-266">Nem kell helyezni az API hívása.</span><span class="sxs-lookup"><span data-stu-id="58a27-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="58a27-267">Miután meghatározta a jól ismert GUID azonosítója a szerepkör-definíció, hogyan hozhat létre a szerepkör-definíció azonosítója, mint:</span><span class="sxs-lookup"><span data-stu-id="58a27-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="58a27-268">Az alábbiakban a gyakran használt beépített szerepkörök jól ismert azonosítóját:</span><span class="sxs-lookup"><span data-stu-id="58a27-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="58a27-269">Szerepkör</span><span class="sxs-lookup"><span data-stu-id="58a27-269">Role</span></span> | <span data-ttu-id="58a27-270">GUID</span><span class="sxs-lookup"><span data-stu-id="58a27-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="58a27-271">Olvasó</span><span class="sxs-lookup"><span data-stu-id="58a27-271">Reader</span></span> |<span data-ttu-id="58a27-272">acdd72a7-3385-48EF-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="58a27-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="58a27-273">Közreműködő</span><span class="sxs-lookup"><span data-stu-id="58a27-273">Contributor</span></span> |<span data-ttu-id="58a27-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="58a27-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="58a27-275">Virtuális gép közreműködő</span><span class="sxs-lookup"><span data-stu-id="58a27-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="58a27-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="58a27-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="58a27-277">Virtuális hálózat közreműködő</span><span class="sxs-lookup"><span data-stu-id="58a27-277">Virtual Network Contributor</span></span> |<span data-ttu-id="58a27-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="58a27-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="58a27-279">Tárolási fiók közreműködői</span><span class="sxs-lookup"><span data-stu-id="58a27-279">Storage Account Contributor</span></span> |<span data-ttu-id="58a27-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="58a27-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="58a27-281">Webhely közreműködő</span><span class="sxs-lookup"><span data-stu-id="58a27-281">Website Contributor</span></span> |<span data-ttu-id="58a27-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="58a27-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="58a27-283">Webes terv közreműködő</span><span class="sxs-lookup"><span data-stu-id="58a27-283">Web Plan Contributor</span></span> |<span data-ttu-id="58a27-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="58a27-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="58a27-285">SQL Server közreműködő</span><span class="sxs-lookup"><span data-stu-id="58a27-285">SQL Server Contributor</span></span> |<span data-ttu-id="58a27-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="58a27-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="58a27-287">SQL DB Contributor</span><span class="sxs-lookup"><span data-stu-id="58a27-287">SQL DB Contributor</span></span> |<span data-ttu-id="58a27-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="58a27-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="58a27-289">Az RBAC szerepkör hozzárendelése alkalmazás</span><span class="sxs-lookup"><span data-stu-id="58a27-289">Assign RBAC role to application</span></span>
<span data-ttu-id="58a27-290">Minden kell a megfelelő RBAC szerepkör hozzárendelése az egyszerű szolgáltatásnév segítségével az [erőforrás-kezelő szerepkör-hozzárendelés létrehozására](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span><span class="sxs-lookup"><span data-stu-id="58a27-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="58a27-291">A [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) az ASP.net MVC mintaalkalmazás metódus valósítja meg a hívás.</span><span class="sxs-lookup"><span data-stu-id="58a27-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="58a27-292">Egy példa egy kérelem RBAC szerepkör hozzárendelése alkalmazás:</span><span class="sxs-lookup"><span data-stu-id="58a27-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="58a27-293">A kérelem a következő értékeket használjuk:</span><span class="sxs-lookup"><span data-stu-id="58a27-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="58a27-294">GUID</span><span class="sxs-lookup"><span data-stu-id="58a27-294">Guid</span></span> | <span data-ttu-id="58a27-295">Leírás</span><span class="sxs-lookup"><span data-stu-id="58a27-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="58a27-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="58a27-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="58a27-297">az előfizetés azonosítóját</span><span class="sxs-lookup"><span data-stu-id="58a27-297">the id of the subscription</span></span> |
| <span data-ttu-id="58a27-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="58a27-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="58a27-299">az alkalmazás a szolgáltatás egyszerű objektum azonosítója</span><span class="sxs-lookup"><span data-stu-id="58a27-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="58a27-300">acdd72a7-3385-48EF-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="58a27-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="58a27-301">az olvasó szerepkört azonosítója</span><span class="sxs-lookup"><span data-stu-id="58a27-301">the id of the reader role</span></span> |
| <span data-ttu-id="58a27-302">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="58a27-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="58a27-303">egy új guid létre új szerepkör-hozzárendelés</span><span class="sxs-lookup"><span data-stu-id="58a27-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="58a27-304">A válasz a következő formátumban kell megadni:</span><span class="sxs-lookup"><span data-stu-id="58a27-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="58a27-305">Szerezze be a csak alkalmazás-hozzáférési tokent az Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="58a27-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="58a27-306">Az alkalmazás ellenőrzése rendelkezik a kívánt előfizetésnek érni, a vizsgálati művelet végrehajtásához a az előfizetés csak alkalmazás token használatával.</span><span class="sxs-lookup"><span data-stu-id="58a27-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="58a27-307">Ahhoz, hogy csak alkalmazás-hozzáférési tokent, kövesse az utasításokat szakaszából [csak alkalmazás-token beszerzése az Azure AD Graph API](#app-azure-ad-graph), egy másik érték megadásával az erőforrás paraméter:</span><span class="sxs-lookup"><span data-stu-id="58a27-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="58a27-308">A [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metódus az ASP.NET MVC mintaalkalmazásnak lekéri csak alkalmazás hozzáférés token az Azure Resource Manager segítségével az Active Directory hitelesítési könyvtár a .NET-hez.</span><span class="sxs-lookup"><span data-stu-id="58a27-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="58a27-309">Az alkalmazás engedélyeket szerezni az előfizetésben</span><span class="sxs-lookup"><span data-stu-id="58a27-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="58a27-310">Ellenőrizze, hogy az alkalmazás hozzáférhet a kívánt Azure-előfizetéssel, akkor előfordulhat, hogy is hívja meg a [erőforrás-kezelő engedélyei](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span><span class="sxs-lookup"><span data-stu-id="58a27-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="58a27-311">Ez a megközelítés hogyan megadta, hogy a felhasználó rendelkezik-e a hozzáférés-kezelés jogosultságokkal az előfizetés hasonlít.</span><span class="sxs-lookup"><span data-stu-id="58a27-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="58a27-312">Most, azonban a az alkalmazás csak jogkivonat az előző lépésben kapott engedélyeket API hívása.</span><span class="sxs-lookup"><span data-stu-id="58a27-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="58a27-313">A [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) az ASP.NET MVC mintaalkalmazás metódus valósítja meg a hívás.</span><span class="sxs-lookup"><span data-stu-id="58a27-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="58a27-314">Csatlakoztatott előfizetések kezelése</span><span class="sxs-lookup"><span data-stu-id="58a27-314">Manage connected subscriptions</span></span>
<span data-ttu-id="58a27-315">A megfelelő RBAC szerepkör van rendelve az alkalmazás egyszerű szolgáltatásnév az előfizetéshez, amikor az alkalmazás is tartsa figyelés vagy kezelése csak alkalmazás-hozzáférési jogkivonatok segítségével csatlakozzon az Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="58a27-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="58a27-316">Ha egy előfizetés tulajdonosa a klasszikus portál vagy a parancssori eszközök használatával az alkalmazás szerepkör-hozzárendelés eltávolítja, az alkalmazás most már érhessék el az adott előfizetéshez.</span><span class="sxs-lookup"><span data-stu-id="58a27-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="58a27-317">Ebben az esetben kell értesíti a felhasználót, hogy az előfizetés létesített kapcsolat megszakadt, a az alkalmazáson kívül, és egy lehetőség, hogy a "javítás" a kapcsolódási számukra.</span><span class="sxs-lookup"><span data-stu-id="58a27-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="58a27-318">"Javítás" egyszerűen akkor hozza létre a kapcsolat nélküli törölt szerepkör-hozzárendelés.</span><span class="sxs-lookup"><span data-stu-id="58a27-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="58a27-319">Előfizetések kapcsolódni az alkalmazáshoz a felhasználó engedélyezve van, mint engedélyeznie kell a felhasználó előfizetések túl megszakítja a kapcsolatot.</span><span class="sxs-lookup"><span data-stu-id="58a27-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="58a27-320">Az access felügyeleti szempontból válassza le azt jelenti, hogy az alkalmazás egyszerű rendelkezik-e az előfizetés a szerepkör-hozzárendelés eltávolítása.</span><span class="sxs-lookup"><span data-stu-id="58a27-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="58a27-321">Ha szükséges az alkalmazásban, az előfizetés olyan állapotokat előfordulhat, hogy el kell távolítani túl.</span><span class="sxs-lookup"><span data-stu-id="58a27-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="58a27-322">Válassza le az előfizetés csak az előfizetés kezelése engedéllyel rendelkező felhasználók is.</span><span class="sxs-lookup"><span data-stu-id="58a27-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="58a27-323">A [RevokeRoleFromServicePrincipalOnSubscription metódus](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) , az ASP.net MVC mintaalkalmazás valósítja meg a hívás.</span><span class="sxs-lookup"><span data-stu-id="58a27-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="58a27-324">Ennyi az egész – a felhasználók most már egyszerűen csatlakozhat, és kezelheti az Azure-előfizetések az alkalmazással.</span><span class="sxs-lookup"><span data-stu-id="58a27-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
