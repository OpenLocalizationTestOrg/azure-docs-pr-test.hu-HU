---
title: "Helyreállítás-kezelő használatával shard térkép problémák elhárításának |} Microsoft Docs"
description: "A RecoveryManager osztály használatával shard maps kapcsolatos problémák megoldásához"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: e60e2295484873ea15d52108b7d619319a57827f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 07/11/2017
---
# <a name="using-the-recoverymanager-class-to-fix-shard-map-problems"></a><span data-ttu-id="62a69-103">Horizontális skálázási térképek javítása a RecoveryManager osztállyal</span><span class="sxs-lookup"><span data-stu-id="62a69-103">Using the RecoveryManager class to fix shard map problems</span></span>
<span data-ttu-id="62a69-104">A [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) osztály teszi lehetővé az ADO.Net alkalmazások felismerését és javítsa ki a globális shard térkép (GSM) és a helyi shard térkép (LSM) szilánkos adatbázis környezetben közötti inkonzisztenciákat.</span><span class="sxs-lookup"><span data-stu-id="62a69-104">The [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications the ability to easily detect and correct any inconsistencies between the global shard map (GSM) and the local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="62a69-105">A globális szolgáltatásfigyelő szolgáltatás és a LSM nyomon követheti az egyes adatbázisok szilánkos környezetben leképezése.</span><span class="sxs-lookup"><span data-stu-id="62a69-105">The GSM and LSM track the mapping of each database in a sharded environment.</span></span> <span data-ttu-id="62a69-106">Alkalmanként szünet a globális szolgáltatásfigyelő szolgáltatás és a LSM között történik.</span><span class="sxs-lookup"><span data-stu-id="62a69-106">Occasionally, a break occurs between the GSM and the LSM.</span></span> <span data-ttu-id="62a69-107">Ebben az esetben használja a RecoveryManager osztály észlelésére, és javítsa ki a szünet.</span><span class="sxs-lookup"><span data-stu-id="62a69-107">In that case, use the RecoveryManager class to detect and repair the break.</span></span>

<span data-ttu-id="62a69-108">A RecoveryManager osztály része a [Elastic Database ügyféloldali kódtárának](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-108">The RecoveryManager class is part of the [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![A shard térkép][1]

<span data-ttu-id="62a69-110">Kifejezés-definíciók, lásd: [rugalmas adatbázis eszközök szószedet](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="62a69-111">Tudni, hogyan a **ShardMapManager** szolgál a szilánkos megoldás adatok kezelésére, olvassa el [Shard térkép felügyeleti](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-111">To understand how the **ShardMapManager** is used to manage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-the-recovery-manager"></a><span data-ttu-id="62a69-112">Miért érdemes használni a helyreállítás-kezelő?</span><span class="sxs-lookup"><span data-stu-id="62a69-112">Why use the recovery manager?</span></span>
<span data-ttu-id="62a69-113">Horizontálisan skálázott adatbázis környezetben nincs adatbázisonként egy bérlői, és számos más adatbázis kiszolgálónként.</span><span class="sxs-lookup"><span data-stu-id="62a69-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="62a69-114">Lehetnek is kiszolgálók számát a környezetben.</span><span class="sxs-lookup"><span data-stu-id="62a69-114">There can also be many servers in the environment.</span></span> <span data-ttu-id="62a69-115">Minden egyes adatbázis hozzá van rendelve a shard térkép hívások irányíthassa megfelelő kiszolgálót és adatbázist.</span><span class="sxs-lookup"><span data-stu-id="62a69-115">Each database is mapped in the shard map, so calls can be routed to the correct server and database.</span></span> <span data-ttu-id="62a69-116">Adatbázisok a következők szerint követi nyomon a rendszer egy **horizontális kulcs**, és minden shard hozzá van rendelve egy **értékek tartományán**.</span><span class="sxs-lookup"><span data-stu-id="62a69-116">Databases are tracked according to a **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="62a69-117">"D" az ügyfélnevek a horizontális kulcs képviselhet például, "F"</span><span class="sxs-lookup"><span data-stu-id="62a69-117">For example, a sharding key may represent the customer names from "D" to "F."</span></span> <span data-ttu-id="62a69-118">Minden szilánkok (más néven adatbázisok) és a leképezés tartományok leképezése tartalmazza a **globális shard térkép (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="62a69-118">The mapping of all shards (aka databases) and their mapping ranges are contained in the **global shard map (GSM)**.</span></span> <span data-ttu-id="62a69-119">Az egyes adatbázisok is található a szilánkcímtárban szerint tartományok térképét tartalmazza a **helyi shard térkép (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="62a69-119">Each database also contains a map of the ranges contained on the shard that is known as the **local shard map (LSM)**.</span></span> <span data-ttu-id="62a69-120">Amikor egy alkalmazás egy shard csatlakozik, a hozzárendelés gyorsítótárazza, és az alkalmazás a gyors beolvasásához.</span><span class="sxs-lookup"><span data-stu-id="62a69-120">When an app connects to a shard, the mapping is cached with the app for quick retrieval.</span></span> <span data-ttu-id="62a69-121">A LSM gyorsítótárazott adatok ellenőrzésére szolgál.</span><span class="sxs-lookup"><span data-stu-id="62a69-121">The LSM is used to validate cached data.</span></span> 

<span data-ttu-id="62a69-122">A globális szolgáltatásfigyelő szolgáltatás és a LSM válhat nincs szinkronban a következők lehetnek az okai:</span><span class="sxs-lookup"><span data-stu-id="62a69-122">The GSM and LSM may become out of sync for the following reasons:</span></span>

1. <span data-ttu-id="62a69-123">A shard, amelynek tartomány feltételezhető, hogy már nem használja, vagy átnevezésének a shard törlését.</span><span class="sxs-lookup"><span data-stu-id="62a69-123">The deletion of a shard whose range is believed to no longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="62a69-124">Egy shard törlése eredményezi egy **árván maradt a szilánkok leképezése**.</span><span class="sxs-lookup"><span data-stu-id="62a69-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="62a69-125">Hasonlóképpen a átnevezett adatbázis egy árva szilánkok leképezése okozhat.</span><span class="sxs-lookup"><span data-stu-id="62a69-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="62a69-126">Attól függően, hogy a módosítás célját a shard esetleg el kell távolítani, vagy frissíteni kell a shard helyét.</span><span class="sxs-lookup"><span data-stu-id="62a69-126">Depending on the intent of the change, the shard may need to be removed or the shard location needs to be updated.</span></span> <span data-ttu-id="62a69-127">A törölt adatbázisok helyreállításához, lásd: [törölt adatbázis visszaállítása](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-127">To recover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="62a69-128">A földrajzi-feladatátadási esemény következik be.</span><span class="sxs-lookup"><span data-stu-id="62a69-128">A geo-failover event occurs.</span></span> <span data-ttu-id="62a69-129">A folytatáshoz egy kell frissíteni, a kiszolgáló nevét, és a shard térkép Manager az alkalmazás nevét, és frissítse a shard térképen az összes szilánkok szilánkok leképezése részleteit.</span><span class="sxs-lookup"><span data-stu-id="62a69-129">To continue, one must update the server name, and database name of shard map manager in the application and then update the shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="62a69-130">Földrajzi-feladatátvétel esetén az ilyen helyreállítási logika belül a feladatátvételi munkafolyamat érdemes automatizálni.</span><span class="sxs-lookup"><span data-stu-id="62a69-130">If there is a geo-failover, such recovery logic should be automated within the failover workflow.</span></span> <span data-ttu-id="62a69-131">Helyreállítási műveletek automatizálása lehetővé teszi, hogy a frictionless kezelhetőségi adatbázisok földrajzi engedélyezve van, és ezzel elkerülheti a manuális emberi műveletek.</span><span class="sxs-lookup"><span data-stu-id="62a69-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="62a69-132">Adatbázis helyreállítása, ha egy adatközpont-meghibásodás után beállításokkal kapcsolatos további tudnivalókért lásd: [az üzletmenet folytonossága](sql-database-business-continuity.md) és [vész-helyreállítási](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-132">To learn about options to recover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="62a69-133">A szilánkok vagy a ShardMapManager adatbázis egy korábbi pont az időpontra állítottak vissza.</span><span class="sxs-lookup"><span data-stu-id="62a69-133">Either a shard or the ShardMapManager database is restored to an earlier point-in time.</span></span> <span data-ttu-id="62a69-134">Időpontra történő visszaállítás biztonsági mentések használatával kapcsolatos további tudnivalókért lásd: [biztonsági másolatokból helyreállítási](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-134">To learn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="62a69-135">Azure SQL Database rugalmas adatbáziseszközöket, georeplikáció és visszaállításával kapcsolatban további információkért tekintse meg a következőket:</span><span class="sxs-lookup"><span data-stu-id="62a69-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see the following:</span></span> 

* [<span data-ttu-id="62a69-136">Áttekintése: A felhő üzleti folytonossági és az adatbázis katasztrófa utáni helyreállítás az SQL Database</span><span class="sxs-lookup"><span data-stu-id="62a69-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="62a69-137">Ismerkedés a rugalmas adatbázis-eszközök</span><span class="sxs-lookup"><span data-stu-id="62a69-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="62a69-138">ShardMap kezelése</span><span class="sxs-lookup"><span data-stu-id="62a69-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="62a69-139">Egy ShardMapManager RecoveryManager lekérése</span><span class="sxs-lookup"><span data-stu-id="62a69-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="62a69-140">Az első lépés, ha a RecoveryManager példánya.</span><span class="sxs-lookup"><span data-stu-id="62a69-140">The first step is to create a RecoveryManager instance.</span></span> <span data-ttu-id="62a69-141">A [GetRecoveryManager metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) adja vissza az aktuális helyreállítás-kezelő [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) példány.</span><span class="sxs-lookup"><span data-stu-id="62a69-141">The [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns the recovery manager for the current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="62a69-142">Kezelje a shard térkép inkonzisztenciákat, az adott shard térkép RecoveryManager először be kell olvasni.</span><span class="sxs-lookup"><span data-stu-id="62a69-142">To address any inconsistencies in the shard map, you must first retrieve the RecoveryManager for the particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="62a69-143">Az ebben a példában a RecoveryManager a ShardMapManager az inicializálása.</span><span class="sxs-lookup"><span data-stu-id="62a69-143">In this example, the RecoveryManager is initialized from the ShardMapManager.</span></span> <span data-ttu-id="62a69-144">Egy ShardMap tartalmazó ShardMapManager is már inicializálva van.</span><span class="sxs-lookup"><span data-stu-id="62a69-144">The ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="62a69-145">Az alkalmazás kódjában a shard térkép maga kezeli, mivel a gyári metódusban (a fenti példában smmConnectionString) használt hitelesítő adatok olvasási és írási jogosultságokkal rendelkezik a kapcsolati karakterlánc által hivatkozott GSM adatbázishoz megadott hitelesítő adatokat kell lennie.</span><span class="sxs-lookup"><span data-stu-id="62a69-145">Since this application code manipulates the shard map itself, the credentials used in the factory method (in the preceding example, smmConnectionString) should be credentials that have read-write permissions on the GSM database referenced by the connection string.</span></span> <span data-ttu-id="62a69-146">Ezek a hitelesítő adatok általában eltérnek a nyitott kapcsolatot az adatok függő továbbításához használt hitelesítő adatokat.</span><span class="sxs-lookup"><span data-stu-id="62a69-146">These credentials are typically different from credentials used to open connections for data-dependent routing.</span></span> <span data-ttu-id="62a69-147">További információkért lásd: [hitelesítő adatokkal a rugalmas adatbázis-ügyfélben](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-147">For more information, see [Using credentials in the elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-the-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="62a69-148">A szilánkok eltávolítása a ShardMap egy shard törlése után</span><span class="sxs-lookup"><span data-stu-id="62a69-148">Removing a shard from the ShardMap after a shard is deleted</span></span>
<span data-ttu-id="62a69-149">A [DetachShard metódus](https://msdn.microsoft.com/library/azure/dn842083.aspx) szervezőről a megadott shard shard leképezés, és törli a shard társított leképezéseket.</span><span class="sxs-lookup"><span data-stu-id="62a69-149">The [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches the given shard from the shard map and deletes mappings associated with the shard.</span></span>  

* <span data-ttu-id="62a69-150">A hely paraméter shard helyét, kifejezetten a kiszolgálónév és a adatbázis nevét, a shard leválasztás alatt áll.</span><span class="sxs-lookup"><span data-stu-id="62a69-150">The location parameter is the shard location, specifically server name and database name, of the shard being detached.</span></span> 
* <span data-ttu-id="62a69-151">A shardMapName paraméter a shard leképezés neve.</span><span class="sxs-lookup"><span data-stu-id="62a69-151">The shardMapName parameter is the shard map name.</span></span> <span data-ttu-id="62a69-152">Ez csak akkor kötelező, ha több shard maps a ugyanazt a shard térkép manager kezeli.</span><span class="sxs-lookup"><span data-stu-id="62a69-152">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="62a69-153">Választható.</span><span class="sxs-lookup"><span data-stu-id="62a69-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="62a69-154">Ez a módszer akkor használja, csak ha biztos abban, hogy a frissített leképezése tartománya üres.</span><span class="sxs-lookup"><span data-stu-id="62a69-154">Use this technique only if you are certain that the range for the updated mapping is empty.</span></span> <span data-ttu-id="62a69-155">A fenti módszerek nem ellenőrzi adatokat át, a tartományhoz, így legjobb ellenőrzések szerepeljenek a kódot.</span><span class="sxs-lookup"><span data-stu-id="62a69-155">The methods above do not check data for the range being moved, so it is best to include checks in your code.</span></span>
>

<span data-ttu-id="62a69-156">Ebben a példában a shard térkép szilánkok eltávolítja.</span><span class="sxs-lookup"><span data-stu-id="62a69-156">This example removes shards from the shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="62a69-157">A szilánkok térkép tükrözi a shard törlése előtt GSM shard helyét.</span><span class="sxs-lookup"><span data-stu-id="62a69-157">The shard map reflects the shard location in the GSM before the deletion of the shard.</span></span> <span data-ttu-id="62a69-158">A szilánkok törölve lett, mert van feltételezi, hogy ez szándékos volt, és a horizontális kulcs tartomány már nem használja.</span><span class="sxs-lookup"><span data-stu-id="62a69-158">Because the shard was deleted, it is assumed this was intentional, and the sharding key range is no longer in use.</span></span> <span data-ttu-id="62a69-159">Ha nem, a visszaállítás egy korábbi időpontra pont a hajthat végre.</span><span class="sxs-lookup"><span data-stu-id="62a69-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="62a69-160">a szilánkok helyreállítása egy korábbi-időpontban.</span><span class="sxs-lookup"><span data-stu-id="62a69-160">to recover the shard from an earlier point-in-time.</span></span> <span data-ttu-id="62a69-161">(Ebben az esetben ellenőrizze az alábbi szakaszt észleléséhez shard inkonzisztenciákat.) Kíván helyreállítani, lásd: [időpontra történő visszaállítás](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="62a69-161">(In that case, review the following section to detect shard inconsistencies.) To recover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="62a69-162">Feltételezzük, hogy az adatbázisok törlése szándékos volt, mert a végső felügyeleti törlési művelete a shard térkép kezelő shard a bejegyzést törölni.</span><span class="sxs-lookup"><span data-stu-id="62a69-162">Since it is assumed the database deletion was intentional, the final administrative cleanup action is to delete the entry to the shard in the shard map manager.</span></span> <span data-ttu-id="62a69-163">Ez megakadályozza, hogy az alkalmazás véletlenül olyan tartománnyal, amely nem várt adatok írásakor.</span><span class="sxs-lookup"><span data-stu-id="62a69-163">This prevents the application from inadvertently writing information to a range that is not expected.</span></span>

## <a name="to-detect-mapping-differences"></a><span data-ttu-id="62a69-164">Leképezési különbségek észlelése</span><span class="sxs-lookup"><span data-stu-id="62a69-164">To detect mapping differences</span></span>
<span data-ttu-id="62a69-165">A [DetectMappingDifferences metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) kiválasztása és igazság forrásaként a shard maps (helyi vagy globális) egyikét adja vissza, és mindkét shard maps (GSM és LSM) leképezése rendezheti.</span><span class="sxs-lookup"><span data-stu-id="62a69-165">The [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="62a69-166">A *hely* határozza meg a kiszolgáló és adatbázis nevét.</span><span class="sxs-lookup"><span data-stu-id="62a69-166">The *location* specifies the server name and database name.</span></span> 
* <span data-ttu-id="62a69-167">A *shardMapName* paramétere a shard leképezés neve.</span><span class="sxs-lookup"><span data-stu-id="62a69-167">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="62a69-168">Erre csak akkor van szükség, ha több shard maps a ugyanazt a shard térkép manager kezeli.</span><span class="sxs-lookup"><span data-stu-id="62a69-168">This is only required if multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="62a69-169">Választható.</span><span class="sxs-lookup"><span data-stu-id="62a69-169">Optional.</span></span> 

## <a name="to-resolve-mapping-differences"></a><span data-ttu-id="62a69-170">Leképezési különbségek megoldásához</span><span class="sxs-lookup"><span data-stu-id="62a69-170">To resolve mapping differences</span></span>
<span data-ttu-id="62a69-171">A [ResolveMappingDifferences metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) igazság forrásaként kiválaszt egy a shard maps (helyi vagy globális), és mindkét shard maps (GSM és LSM) leképezése összehangolja.</span><span class="sxs-lookup"><span data-stu-id="62a69-171">The [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="62a69-172">A *RecoveryToken* paraméter enumerálása a leképezéseket a globális szolgáltatásfigyelő szolgáltatás és az adott shard LSM közötti különbségeket.</span><span class="sxs-lookup"><span data-stu-id="62a69-172">The *RecoveryToken* parameter enumerates the differences in the mappings between the GSM and the LSM for the specific shard.</span></span> 
* <span data-ttu-id="62a69-173">A [MappingDifferenceResolution számbavételi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) jelzi az a különbség a shard leképezések megoldásának módszere.</span><span class="sxs-lookup"><span data-stu-id="62a69-173">The [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used to indicate the method for resolving the difference between the shard mappings.</span></span> 
* <span data-ttu-id="62a69-174">**MappingDifferenceResolution.KeepShardMapping** ajánlott, ha a LSM tartalmazza a pontos, ezért a a szilánkok leképezése használható.</span><span class="sxs-lookup"><span data-stu-id="62a69-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when the LSM contains the accurate mapping and therefore the mapping in the shard should be used.</span></span> <span data-ttu-id="62a69-175">Ez általában az az eset, feladatátvétel esetén: a shard mostantól egy új kiszolgálón található.</span><span class="sxs-lookup"><span data-stu-id="62a69-175">This is typically the case if there is a failover: the shard now resides on a new server.</span></span> <span data-ttu-id="62a69-176">A szilánkok először el kell távolítani a GSM (a RecoveryManager.DetachShard módszer alkalmazásával), mert a leképezés már nem létezik, a GSM a.</span><span class="sxs-lookup"><span data-stu-id="62a69-176">Since the shard must first be removed from the GSM (using the RecoveryManager.DetachShard method), a mapping no longer exists on the GSM.</span></span> <span data-ttu-id="62a69-177">Ezért a LSM hozhatók létre újra a szilánkok leképezése.</span><span class="sxs-lookup"><span data-stu-id="62a69-177">Therefore, the LSM must be used to re-establish the shard mapping.</span></span>

## <a name="attach-a-shard-to-the-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="62a69-178">A szilánkok csatolása a ShardMap egy shard történt visszaállítása után</span><span class="sxs-lookup"><span data-stu-id="62a69-178">Attach a shard to the ShardMap after a shard is restored</span></span>
<span data-ttu-id="62a69-179">A [AttachShard metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) az adott shard csatolja a shard leképezés.</span><span class="sxs-lookup"><span data-stu-id="62a69-179">The [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches the given shard to the shard map.</span></span> <span data-ttu-id="62a69-180">Ezután shard térkép inkonzisztenciákat észlelt, és frissíti a shard visszaállítását helyén shard kereséséhez.</span><span class="sxs-lookup"><span data-stu-id="62a69-180">It then detects any shard map inconsistencies and updates the mappings to match the shard at the point of the shard restoration.</span></span> <span data-ttu-id="62a69-181">Feltételezzük, hogy az adatbázis is átnevezi az eredeti adatbázis név (előtt a shard vissza lett állítva), mivel az a pont a idő visszaállítás az alapértelmezett hozzáfűzi a Timestamp értékkel rendelkező új adatbázist.</span><span class="sxs-lookup"><span data-stu-id="62a69-181">It is assumed that the database is also renamed to reflect the original database name (before the shard was restored), since the point-in time restoration defaults to a new database appended with the timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="62a69-182">A *hely* paraméter a kiszolgáló nevét és adatbázis nevét, az éppen csatolt szilánkcímtárban.</span><span class="sxs-lookup"><span data-stu-id="62a69-182">The *location* parameter is the server name and database name, of the shard being attached.</span></span> 
* <span data-ttu-id="62a69-183">A *shardMapName* paramétere a shard leképezés neve.</span><span class="sxs-lookup"><span data-stu-id="62a69-183">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="62a69-184">Ez csak akkor kötelező, ha több shard maps a ugyanazt a shard térkép manager kezeli.</span><span class="sxs-lookup"><span data-stu-id="62a69-184">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="62a69-185">Választható.</span><span class="sxs-lookup"><span data-stu-id="62a69-185">Optional.</span></span> 

<span data-ttu-id="62a69-186">Ebben a példában a shard hozzáadja a shard leképezés, amely egy korábbi pont óta nemrég helyreállt.</span><span class="sxs-lookup"><span data-stu-id="62a69-186">This example adds a shard to the shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="62a69-187">A szilánkok (azaz a leképezést a LSM a szilánkok) vissza lett állítva, mert nem a shard bejegyzése a GSM potenciálisan következetes.</span><span class="sxs-lookup"><span data-stu-id="62a69-187">Since the shard (namely the mapping for the shard in the LSM) has been restored, it is potentially inconsistent with the shard entry in the GSM.</span></span> <span data-ttu-id="62a69-188">A példakódot kívül a shard visszaállítani, és az eredeti nevére, az adatbázis neve.</span><span class="sxs-lookup"><span data-stu-id="62a69-188">Outside of this example code, the shard was restored and renamed to the original name of the database.</span></span> <span data-ttu-id="62a69-189">Vissza lett állítva, mivel feltételezzük leképezése a LSM a nem megbízható leképezése.</span><span class="sxs-lookup"><span data-stu-id="62a69-189">Since it was restored, it is assumed the mapping in the LSM is the trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-the-shards"></a><span data-ttu-id="62a69-190">Egy földrajzi-feladatátvételt követően (visszaállítás) a a szilánkok shard helyek frissítése</span><span class="sxs-lookup"><span data-stu-id="62a69-190">Updating shard locations after a geo-failover (restore) of the shards</span></span>
<span data-ttu-id="62a69-191">A földrajzi feladatátvétel esetén a másodlagos adatbázis írási elérhető lesz, és válik az új elsődleges adatbázis.</span><span class="sxs-lookup"><span data-stu-id="62a69-191">If there is a geo-failover, the secondary database is made write accessible and becomes the new primary database.</span></span> <span data-ttu-id="62a69-192">Lehet, hogy a kiszolgáló, és potenciálisan (konfigurációtól függően), az adatbázis neve eltér az eredeti elsődleges.</span><span class="sxs-lookup"><span data-stu-id="62a69-192">The name of the server, and potentially the database (depending on your configuration), may be different from the original primary.</span></span> <span data-ttu-id="62a69-193">Ezért a leképezési bejegyzéseket a GSM és LSM shard javítani kell.</span><span class="sxs-lookup"><span data-stu-id="62a69-193">Therefore the mapping entries for the shard in the GSM and LSM must be fixed.</span></span> <span data-ttu-id="62a69-194">Hasonló módon ha az adatbázis helyreállítása egy másik nevet vagy helyet, vagy egy korábbi időpontbeli időben Ez okozhatja inkonzisztenciát a shard leképezésekben.</span><span class="sxs-lookup"><span data-stu-id="62a69-194">Similarly, if the database is restored to a different name or location, or to an earlier point in time, this might cause inconsistencies in the shard maps.</span></span> <span data-ttu-id="62a69-195">A szilánkok térkép Manager nyitott kapcsolatot annak a megfelelő adatbázis terjesztési kezeli.</span><span class="sxs-lookup"><span data-stu-id="62a69-195">The Shard Map Manager handles the distribution of open connections to the correct database.</span></span> <span data-ttu-id="62a69-196">Terjesztési a shard és az alkalmazások kérelem céljaként a horizontális kulcsnak az értéke az adatokon alapul.</span><span class="sxs-lookup"><span data-stu-id="62a69-196">Distribution is based on the data in the shard map and the value of the sharding key that is the target of the applications request.</span></span> <span data-ttu-id="62a69-197">Egy földrajzi-feladatátvétel után ezek az információk frissíteni kell a pontos kiszolgáló neve, az adatbázisnév és a helyreállított adatbázis szilánkok leképezése.</span><span class="sxs-lookup"><span data-stu-id="62a69-197">After a geo-failover, this information must be updated with the accurate server name, database name and shard mapping of the recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="62a69-198">Ajánlott eljárások</span><span class="sxs-lookup"><span data-stu-id="62a69-198">Best practices</span></span>
<span data-ttu-id="62a69-199">Földrajzi-feladatátvételi és helyreállítási műveletek általában kezeli a felhő rendszergazdájának az alkalmazás szándékosan okhoz egy Azure SQL-adatbázisok üzleti folytonosságot biztosító szolgáltatásokat, amelyek.</span><span class="sxs-lookup"><span data-stu-id="62a69-199">Geo-failover and recovery are operations typically managed by a cloud administrator of the application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="62a69-200">Üzleti folytonossági tervezési folyamatok, eljárások és intézkedéseket, győződjön meg arról, hogy üzleti műveletek megszakítás nélkül továbbra is igényel.</span><span class="sxs-lookup"><span data-stu-id="62a69-200">Business continuity planning requires processes, procedures, and measures to ensure that business operations can continue without interruption.</span></span> <span data-ttu-id="62a69-201">A módszer áll rendelkezésre, része a RecoveryManager osztálynak kell használni a munkafolyamat győződjön meg arról, a GSM és LSM mindig naprakészek alapján a helyreállítási műveletről.</span><span class="sxs-lookup"><span data-stu-id="62a69-201">The methods available as part of the RecoveryManager class should be used within this work flow to ensure the GSM and LSM are kept up-to-date based on the recovery action taken.</span></span> <span data-ttu-id="62a69-202">Nincsenek megfelelően biztosítva a GSM és LSM tükrözik a pontos információk lekérdezésének a feladatátadási esemény után öt alapvető lépéseit.</span><span class="sxs-lookup"><span data-stu-id="62a69-202">There are five basic steps to properly ensuring the GSM and LSM reflect the accurate information after a failover event.</span></span> <span data-ttu-id="62a69-203">Az alkalmazás kódjának a lépések végrehajtása integrálható a meglévő eszközöket és a munkafolyamat.</span><span class="sxs-lookup"><span data-stu-id="62a69-203">The application code to execute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="62a69-204">A RecoveryManager lekérése a ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="62a69-204">Retrieve the RecoveryManager from the ShardMapManager.</span></span> 
2. <span data-ttu-id="62a69-205">Válassza le a régi shard shard leképezés.</span><span class="sxs-lookup"><span data-stu-id="62a69-205">Detach the old shard from the shard map.</span></span>
3. <span data-ttu-id="62a69-206">Az új shard csatolása a shard térkép, beleértve az új shard helyre.</span><span class="sxs-lookup"><span data-stu-id="62a69-206">Attach the new shard to the shard map, including the new shard location.</span></span>
4. <span data-ttu-id="62a69-207">A globális szolgáltatásfigyelő szolgáltatás és a LSM közötti leképezést inkonzisztenciát észlelését.</span><span class="sxs-lookup"><span data-stu-id="62a69-207">Detect inconsistencies in the mapping between the GSM and LSM.</span></span> 
5. <span data-ttu-id="62a69-208">Szüntesse meg a globális szolgáltatásfigyelő szolgáltatás és a LSM, megbízva abban a LSM közötti különbséget.</span><span class="sxs-lookup"><span data-stu-id="62a69-208">Resolve differences between the GSM and the LSM, trusting the LSM.</span></span> 

<span data-ttu-id="62a69-209">Ebben a példában a következő lépéseket végzi el:</span><span class="sxs-lookup"><span data-stu-id="62a69-209">This example performs the following steps:</span></span>

1. <span data-ttu-id="62a69-210">A szilánkok térkép, hogy tükrözze a feladatátvétel megtörténte előtt shard helyek szilánkok eltávolítja.</span><span class="sxs-lookup"><span data-stu-id="62a69-210">Removes shards from the Shard Map that reflect shard locations before the failover event.</span></span>
2. <span data-ttu-id="62a69-211">A szilánkok térkép az új shard helyek (a "Configuration.SecondaryServer" paramétere az új kiszolgáló nevét, de azonos adatbázisnévvel) tükröző szilánkok csatlakozik.</span><span class="sxs-lookup"><span data-stu-id="62a69-211">Attaches shards to the Shard Map reflecting the new shard locations (the parameter "Configuration.SecondaryServer" is the new server name but the same database name).</span></span>
3. <span data-ttu-id="62a69-212">A helyreállítási jogkivonatok lekéri a globális szolgáltatásfigyelő szolgáltatás és az egyes shard LSM leképezési különbségei észlelésével.</span><span class="sxs-lookup"><span data-stu-id="62a69-212">Retrieves the recovery tokens by detecting mapping differences between the GSM and the LSM for each shard.</span></span> 
4. <span data-ttu-id="62a69-213">Oldja fel az inkonzisztenciák által az egyes shard LSM a leképezés a megbízó.</span><span class="sxs-lookup"><span data-stu-id="62a69-213">Resolves the inconsistencies by trusting the mapping from the LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

