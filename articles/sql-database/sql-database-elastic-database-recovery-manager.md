---
title: "aaaUsing helyreállítás-kezelő toofix szilánkok leképezése problémák |} Microsoft Docs"
description: "Hello RecoveryManager osztály toosolve problémák shard maps használata"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="22bad-103">Hello RecoveryManager osztály toofix shard térkép problémák használatával</span><span class="sxs-lookup"><span data-stu-id="22bad-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="22bad-104">Hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) osztály lehetővé teszi a ADO.Net hello képességét tooeasily észleli, és kijavíthatja az hello globális shard térkép (GSM) és hello helyi shard térkép (LSM) szilánkos adatbázis környezetben közötti inkonzisztenciákat.</span><span class="sxs-lookup"><span data-stu-id="22bad-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="22bad-105">hello GSM és LSM követése hello hozzárendelése minden egyes adatbázis szilánkos környezetben.</span><span class="sxs-lookup"><span data-stu-id="22bad-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="22bad-106">Alkalmanként szünet hello GSM és hello LSM között történik.</span><span class="sxs-lookup"><span data-stu-id="22bad-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="22bad-107">Ebben az esetben hello RecoveryManager osztály toodetect használja, és javítsa hello sortörés.</span><span class="sxs-lookup"><span data-stu-id="22bad-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="22bad-108">hello RecoveryManager osztály hello része [Elastic Database ügyféloldali kódtárának](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![A shard térkép][1]

<span data-ttu-id="22bad-110">Kifejezés-definíciók, lásd: [rugalmas adatbázis eszközök szószedet](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="22bad-111">Hogyan hello toounderstand **ShardMapManager** használt toomanage adatok a szilánkos megoldás lásd: [Shard térkép felügyeleti](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="22bad-112">Miért érdemes használni a helyreállítás-kezelő hello?</span><span class="sxs-lookup"><span data-stu-id="22bad-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="22bad-113">Horizontálisan skálázott adatbázis környezetben nincs adatbázisonként egy bérlői, és számos más adatbázis kiszolgálónként.</span><span class="sxs-lookup"><span data-stu-id="22bad-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="22bad-114">Lehetnek is sok kiszolgálók hello környezetben.</span><span class="sxs-lookup"><span data-stu-id="22bad-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="22bad-115">Minden egyes adatbázis hozzá van rendelve hello shard leképezés, így hívások lehet irányított toohello megfelelő kiszolgálót és adatbázist.</span><span class="sxs-lookup"><span data-stu-id="22bad-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="22bad-116">Adatbázisok tooa szerint követi **horizontális kulcs**, és minden shard hozzá van rendelve egy **értékek tartományán**.</span><span class="sxs-lookup"><span data-stu-id="22bad-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="22bad-117">Például egy horizontális skálázási kulcs képviselhet hello ügyfélnevek "D" túl "F."</span><span class="sxs-lookup"><span data-stu-id="22bad-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="22bad-118">hello (más néven adatbázisok) összes szilánkok leképezése és hello található a leképezési tartományok **globális shard térkép (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="22bad-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="22bad-119">Minden adatbázis is tartalmaz hello shard szerint hello tartalmazott hello tartományait térképre **helyi shard térkép (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="22bad-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="22bad-120">Amikor egy alkalmazás tooa shard csatlakozik, a rendszer gyorsítótárazza a hello leképezési hello alkalmazással a gyors beolvasásához.</span><span class="sxs-lookup"><span data-stu-id="22bad-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="22bad-121">hello LSM használt toovalidate gyorsítótárazott adatokat.</span><span class="sxs-lookup"><span data-stu-id="22bad-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="22bad-122">hello GSM és LSM válhat a következő okok miatt hello szinkronban:</span><span class="sxs-lookup"><span data-stu-id="22bad-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="22bad-123">egy amelynek tartomány várakozások toono hosszabb ideig szilánkcímtárban hello törlésének kell használatával, vagy átnevezésének a szilánkcímtárban.</span><span class="sxs-lookup"><span data-stu-id="22bad-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="22bad-124">Egy shard törlése eredményezi egy **árván maradt a szilánkok leképezése**.</span><span class="sxs-lookup"><span data-stu-id="22bad-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="22bad-125">Hasonlóképpen a átnevezett adatbázis egy árva szilánkok leképezése okozhat.</span><span class="sxs-lookup"><span data-stu-id="22bad-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="22bad-126">Attól függően, hogy hello szándékával hello módosítása hello shard eltávolított toobe van szüksége, vagy hello shard hely toobe frissíteni kell.</span><span class="sxs-lookup"><span data-stu-id="22bad-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="22bad-127">a törölt adatbázisok toorecover lásd [törölt adatbázis visszaállítása](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="22bad-128">A földrajzi-feladatátadási esemény következik be.</span><span class="sxs-lookup"><span data-stu-id="22bad-128">A geo-failover event occurs.</span></span> <span data-ttu-id="22bad-129">toocontinue, egy frissítenie kell hello kiszolgáló nevét, és shard térképen az összes szilánkok hello alkalmazást, majd a frissítés hello szilánkok leképezése részletei shard térkép Manager-adatbázis neve.</span><span class="sxs-lookup"><span data-stu-id="22bad-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="22bad-130">A földrajzi feladatátvétel esetén ilyen helyreállítási logika érdemes automatizálni hello feladatátvételi munkafolyamaton belül.</span><span class="sxs-lookup"><span data-stu-id="22bad-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="22bad-131">Helyreállítási műveletek automatizálása lehetővé teszi, hogy a frictionless kezelhetőségi adatbázisok földrajzi engedélyezve van, és ezzel elkerülheti a manuális emberi műveletek.</span><span class="sxs-lookup"><span data-stu-id="22bad-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="22bad-132">egy adatbázist, ha egy adatközpont-meghibásodás után, olvassa el a beállítások toorecover kapcsolatos toolearn [az üzletmenet folytonossága](sql-database-business-continuity.md) és [vész-helyreállítási](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="22bad-133">A shard vagy hello ShardMapManager adatbázisa visszaállított tooan korábbi pont idő.</span><span class="sxs-lookup"><span data-stu-id="22bad-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="22bad-134">toolearn időpontra történő visszaállítás biztonsági mentések használatával kapcsolatban lásd: [biztonsági másolatokból helyreállítási](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="22bad-135">Azure SQL Database rugalmas adatbáziseszközöket, georeplikáció és visszaállításával kapcsolatban további információkért lásd: hello következő:</span><span class="sxs-lookup"><span data-stu-id="22bad-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="22bad-136">Áttekintése: A felhő üzleti folytonossági és az adatbázis katasztrófa utáni helyreállítás az SQL Database</span><span class="sxs-lookup"><span data-stu-id="22bad-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="22bad-137">Ismerkedés a rugalmas adatbázis-eszközök</span><span class="sxs-lookup"><span data-stu-id="22bad-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="22bad-138">ShardMap kezelése</span><span class="sxs-lookup"><span data-stu-id="22bad-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="22bad-139">Egy ShardMapManager RecoveryManager lekérése</span><span class="sxs-lookup"><span data-stu-id="22bad-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="22bad-140">hello első lépéseként toocreate egy RecoveryManager példány.</span><span class="sxs-lookup"><span data-stu-id="22bad-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="22bad-141">Hello [GetRecoveryManager metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) értéket ad vissza az aktuális hello helyreállítás-kezelő hello [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) példány.</span><span class="sxs-lookup"><span data-stu-id="22bad-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="22bad-142">tooaddress esetlegesen bekövetkező Inkonzisztencia a hello szilánkok leképezése, hello RecoveryManager hello adott shard térkép először be kell olvasni.</span><span class="sxs-lookup"><span data-stu-id="22bad-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="22bad-143">Az ebben a példában az hello RecoveryManager hello ShardMapManager az inicializálása.</span><span class="sxs-lookup"><span data-stu-id="22bad-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="22bad-144">egy ShardMap tartalmazó ShardMapManager hello is már inicializálva van.</span><span class="sxs-lookup"><span data-stu-id="22bad-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="22bad-145">Az alkalmazás kódjában hello shard térkép maga kezeli, mivel hello hello gyártómetódussal során használt hitelesítő adatok (az előző példában hello smmConnectionString) hitelesítő adatokat, amelyek hello által hivatkozott hello GSM adatbázis írási / olvasási engedélyeket kell lennie. kapcsolati karakterlánc.</span><span class="sxs-lookup"><span data-stu-id="22bad-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="22bad-146">Ezek a hitelesítő adatok általában eltérnek a használt hitelesítő adatok tooopen kapcsolatok az adatok függő továbbításához.</span><span class="sxs-lookup"><span data-stu-id="22bad-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="22bad-147">További információkért lásd: [hello rugalmas adatbázis-ügyfél a hitelesítő adatok használatával](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="22bad-148">A szilánkok eltávolítása hello ShardMap egy shard törlése után</span><span class="sxs-lookup"><span data-stu-id="22bad-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="22bad-149">Hello [DetachShard metódus](https://msdn.microsoft.com/library/azure/dn842083.aspx) szervezőről a megadott shard hello shard leképezés hello és hello shard társított hozzárendelések törlése.</span><span class="sxs-lookup"><span data-stu-id="22bad-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="22bad-150">hello hely paraméter hello shard helyét, kifejezetten a kiszolgáló neve és az adatbázis nevét, a hello shard leválasztás alatt áll.</span><span class="sxs-lookup"><span data-stu-id="22bad-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="22bad-151">hello shardMapName paraméter hello shard leképezés neve.</span><span class="sxs-lookup"><span data-stu-id="22bad-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="22bad-152">Ez a tulajdonság csak akkor szükséges, ha több shard maps hello által kezelt ugyanazt a shard térkép manager.</span><span class="sxs-lookup"><span data-stu-id="22bad-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="22bad-153">Választható.</span><span class="sxs-lookup"><span data-stu-id="22bad-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="22bad-154">Ez a módszer akkor használja, csak akkor, ha biztos benne, hogy hello frissítése hello leképezés értéke üres.</span><span class="sxs-lookup"><span data-stu-id="22bad-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="22bad-155">a fenti hello módszerek hello tartomány áthelyezett adatok ellenőrzése, a legjobb tooinclude ellenőrzi a kódban.</span><span class="sxs-lookup"><span data-stu-id="22bad-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="22bad-156">Ez a példa szilánkok hello shard térkép eltávolítja.</span><span class="sxs-lookup"><span data-stu-id="22bad-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="22bad-157">hello shard térkép tükrözi hello shard helyét hello GSM hello shard hello törlése előtt.</span><span class="sxs-lookup"><span data-stu-id="22bad-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="22bad-158">Hello shard törölve lett, mert van feltételezi, hogy ez szándékos volt, és hello horizontális kulcs tartomány már nem használja.</span><span class="sxs-lookup"><span data-stu-id="22bad-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="22bad-159">Ha nem, a visszaállítás egy korábbi időpontra pont a hajthat végre.</span><span class="sxs-lookup"><span data-stu-id="22bad-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="22bad-160">toorecover hello shard a egy korábbi-időpontban.</span><span class="sxs-lookup"><span data-stu-id="22bad-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="22bad-161">(Ebben az esetben tekintse át a következő szakasz toodetect shard inkonzisztenciát hello.) toorecover, lásd: [időpontra történő visszaállítás](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="22bad-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="22bad-162">Feltételezzük, hogy szándékos volt hello adatbázisok törlése, mivel hello végső felügyeleti törlési művelete toodelete hello bejegyzés toohello shard hello shard térkép Manager.</span><span class="sxs-lookup"><span data-stu-id="22bad-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="22bad-163">Ez megakadályozza, hogy a nem várt információkat tooa tartomány véletlenül írásában hello alkalmazás.</span><span class="sxs-lookup"><span data-stu-id="22bad-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="22bad-164">toodetect leképezési különbségek</span><span class="sxs-lookup"><span data-stu-id="22bad-164">toodetect mapping differences</span></span>
<span data-ttu-id="22bad-165">Hello [DetectMappingDifferences metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) kiválasztása és igazság hello adatforrásként hello shard maps (helyi vagy globális) egyikét adja vissza, és mindkét shard maps (GSM és LSM) leképezése rendezheti.</span><span class="sxs-lookup"><span data-stu-id="22bad-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="22bad-166">Hello *hely* hello kiszolgáló és a nevét adja meg.</span><span class="sxs-lookup"><span data-stu-id="22bad-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="22bad-167">Hello *shardMapName* paraméter hello shard leképezés neve.</span><span class="sxs-lookup"><span data-stu-id="22bad-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="22bad-168">Erre csak akkor van szükség, ha több shard maps hello által kezelt ugyanazt a shard térkép manager.</span><span class="sxs-lookup"><span data-stu-id="22bad-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="22bad-169">Választható.</span><span class="sxs-lookup"><span data-stu-id="22bad-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="22bad-170">tooresolve leképezési különbségek</span><span class="sxs-lookup"><span data-stu-id="22bad-170">tooresolve mapping differences</span></span>
<span data-ttu-id="22bad-171">Hello [ResolveMappingDifferences metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) igazság hello adatforrásként kiválaszt egy hello shard maps (helyi vagy globális), és mindkét shard maps (GSM és LSM) leképezése összehangolja.</span><span class="sxs-lookup"><span data-stu-id="22bad-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="22bad-172">Hello *RecoveryToken* paraméter enumerálása hello hello leképezések és közötti különbségeket hello GSM hello LSM a hello adott szilánkcímtárban.</span><span class="sxs-lookup"><span data-stu-id="22bad-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="22bad-173">Hello [MappingDifferenceResolution számbavételi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) használt tooindicate hello módszer kapcsolatos hello shard hozzárendelések hello különbsége.</span><span class="sxs-lookup"><span data-stu-id="22bad-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="22bad-174">**MappingDifferenceResolution.KeepShardMapping** ajánlott, ha hello LSM tartalmazza a hello pontos, ezért hello shard hello leképezését használható.</span><span class="sxs-lookup"><span data-stu-id="22bad-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="22bad-175">Ez helyzet általában hello feladatátvétel esetén: hello shard mostantól egy új kiszolgálón található.</span><span class="sxs-lookup"><span data-stu-id="22bad-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="22bad-176">Hello shard először el kell távolítani hello GSM (hello RecoveryManager.DetachShard módszer alkalmazásával), mert a leképezés már nem létezik, a hello GSM.</span><span class="sxs-lookup"><span data-stu-id="22bad-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="22bad-177">Emiatt hello LSM kell lennie a használt toore-hello shard leképezés létrehozásához.</span><span class="sxs-lookup"><span data-stu-id="22bad-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="22bad-178">A szilánkok toohello ShardMap csatolni egy shard történt visszaállítása után</span><span class="sxs-lookup"><span data-stu-id="22bad-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="22bad-179">Hello [AttachShard metódus](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) rendeli hello adott shard toohello shard leképezés.</span><span class="sxs-lookup"><span data-stu-id="22bad-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="22bad-180">Ezután shard térkép inkonzisztenciákat észlelt, és hello hozzárendelések toomatch hello shard hello shard visszaállítás hello pontján frissíti.</span><span class="sxs-lookup"><span data-stu-id="22bad-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="22bad-181">Feltételezzük, hogy hello az adatbázis egyben átnevezett tooreflect hello eredeti adatbázisnév (előtt hello shard vissza lett állítva), mert hello pont ideje visszaállítás alapértelmezés szerint használt érték hozzáíródik hello időbélyeg tooa új adatbázis.</span><span class="sxs-lookup"><span data-stu-id="22bad-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="22bad-182">Hello *hely* paraméter hello kiszolgáló és adatbázis nevét, az éppen csatolt hello szilánkcímtárban.</span><span class="sxs-lookup"><span data-stu-id="22bad-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="22bad-183">Hello *shardMapName* paraméter hello shard leképezés neve.</span><span class="sxs-lookup"><span data-stu-id="22bad-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="22bad-184">Ez a tulajdonság csak akkor szükséges, ha több shard maps hello által kezelt ugyanazt a shard térkép manager.</span><span class="sxs-lookup"><span data-stu-id="22bad-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="22bad-185">Választható.</span><span class="sxs-lookup"><span data-stu-id="22bad-185">Optional.</span></span> 

<span data-ttu-id="22bad-186">Ebben a példában a shard toohello shard térképen nemrég helyreállt a pont a korábbi időpontra hozzáadja.</span><span class="sxs-lookup"><span data-stu-id="22bad-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="22bad-187">Hello shard (azaz a hello LSM hello szilánkok leképezése hello) vissza lett állítva, mert nem potenciálisan következetes hello GSM hello shard bejegyzése.</span><span class="sxs-lookup"><span data-stu-id="22bad-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="22bad-188">Ez a példa kód kívül hello shard vissza lett állítva, és átnevezett toohello hello adatbázis eredeti neve.</span><span class="sxs-lookup"><span data-stu-id="22bad-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="22bad-189">Vissza lett állítva, mivel feltételezzük hello LSM hello leképezését hello megbízható leképezés.</span><span class="sxs-lookup"><span data-stu-id="22bad-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="22bad-190">Egy földrajzi-feladatátvételt követően (visszaállítás) a hello szilánkok shard helyek frissítése</span><span class="sxs-lookup"><span data-stu-id="22bad-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="22bad-191">A földrajzi feladatátvétel esetén a hello másodlagos adatbázis írási elérhető lesz, és hello új elsődleges adatbázis válik.</span><span class="sxs-lookup"><span data-stu-id="22bad-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="22bad-192">hello hello kiszolgálójának nevét, és potenciálisan hello adatbázis (attól függően, hogy a konfiguráció), előfordulhat, hogy különböző hello eredeti elsődleges.</span><span class="sxs-lookup"><span data-stu-id="22bad-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="22bad-193">Ezért hello hello shard hello GSM a leképezési bejegyzést, és LSM javítani kell.</span><span class="sxs-lookup"><span data-stu-id="22bad-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="22bad-194">Hasonlóképpen, ha hello adatbázisa visszaállított tooa másik nevet vagy helyet vagy tooan idő korábbi pont, ez lehet, hogy inkonzisztenciát okozhat hello shard leképezések.</span><span class="sxs-lookup"><span data-stu-id="22bad-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="22bad-195">hello Shard térkép Manager hello terjesztési nyitott kapcsolatok toohello megfelelő adatbázis kezeli.</span><span class="sxs-lookup"><span data-stu-id="22bad-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="22bad-196">Terjesztési hello shard és hello horizontális kulcs, amely hello cél hello alkalmazások kérelem hello értékének hello adatokon alapul.</span><span class="sxs-lookup"><span data-stu-id="22bad-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="22bad-197">Egy földrajzi-feladatátvétel után ezek az információk hello pontos kiszolgáló nevét, az adatbázisnév és a szilánkok leképezése hello helyreállított adatbázis frissíteni kell.</span><span class="sxs-lookup"><span data-stu-id="22bad-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="22bad-198">Ajánlott eljárások</span><span class="sxs-lookup"><span data-stu-id="22bad-198">Best practices</span></span>
<span data-ttu-id="22bad-199">Földrajzi-feladatátvételi és helyreállítási műveletek általában kezeli a felhő rendszergazdájának hello alkalmazás szándékosan okhoz egy Azure SQL-adatbázisok üzleti folytonosságot biztosító szolgáltatásokat, amelyek.</span><span class="sxs-lookup"><span data-stu-id="22bad-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="22bad-200">Üzleti folytonossági tervezési folyamatok, eljárások és intézkedések tooensure, amely az üzleti tevékenységre megszakítás nélkül továbbra is szükséges.</span><span class="sxs-lookup"><span data-stu-id="22bad-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="22bad-201">hello módszer használható, mert hello RecoveryManager osztály részét kell használni a munkahelyi folyamat tooensure hello belül GSM és LSM mindig naprakészek alapján hello helyreállítási műveletről.</span><span class="sxs-lookup"><span data-stu-id="22bad-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="22bad-202">Öt alapvető lépést hello biztosítása tooproperly GSM és LSM tükrözik hello pontos információk lekérdezésének a feladatátadási esemény után.</span><span class="sxs-lookup"><span data-stu-id="22bad-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="22bad-203">Ezeket a lépéseket integrálható a meglévő eszközök és a munkafolyamat alkalmazás kód tooexecute hello.</span><span class="sxs-lookup"><span data-stu-id="22bad-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="22bad-204">Hello ShardMapManager hello RecoveryManager lekérni.</span><span class="sxs-lookup"><span data-stu-id="22bad-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="22bad-205">Válassza le a régi shard hello hello shard leképezés.</span><span class="sxs-lookup"><span data-stu-id="22bad-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="22bad-206">Rendeljen a hello új shard toohello shard leképezés, többek között a hello shard helyre.</span><span class="sxs-lookup"><span data-stu-id="22bad-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="22bad-207">Leképezési közötti hello GSM és LSM hello inkonzisztenciát észlelését.</span><span class="sxs-lookup"><span data-stu-id="22bad-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="22bad-208">Szüntesse meg a globális szolgáltatásfigyelő szolgáltatás hello és hello LSM, megbízó hello LSM közötti különbséget.</span><span class="sxs-lookup"><span data-stu-id="22bad-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="22bad-209">Ebben a példában a lépéseket követve hello hajtja végre:</span><span class="sxs-lookup"><span data-stu-id="22bad-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="22bad-210">Szilánkok eltávolítása hello Shard térkép, hogy tükrözze a shard helyek hello feladatátvétel megtörténte előtt.</span><span class="sxs-lookup"><span data-stu-id="22bad-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="22bad-211">Csatolja a szilánkok toohello Shard térkép tükröző hello shard helyét (hello paraméter "Configuration.SecondaryServer" hello új kiszolgáló neve, de azonos hello adatbázis neve).</span><span class="sxs-lookup"><span data-stu-id="22bad-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="22bad-212">Lekéri a hello helyreállítási jogkivonatok hello GSM és hello LSM az egyes szilánkok leképezése különbségei észlelésével.</span><span class="sxs-lookup"><span data-stu-id="22bad-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="22bad-213">Oldja fel a hello inkonzisztenciát által az egyes shard LSM hello megbízó hello-leképezés.</span><span class="sxs-lookup"><span data-stu-id="22bad-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

